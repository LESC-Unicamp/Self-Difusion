```
                                    ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣤⣤⣴⣶⡆⠀⣶⣶⣦⣤⣤⣄⠀ ⢠⣾⣿⣦
                                    ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⡀⢰⣿⣿⣿⣿⣿⣿⣿⡇⠀⣿⣿⣿⣿⣿⣿⡄⠘⢿⣿⠟
                                    ⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣾⣿⣧⠀⢻⣿⣿⣿⣿⣿⣿⡇⠀⣿⣿⣿⣿⣿⣿⣿⠂⢠⣠⣤⣶⣦⡀
                                    ⠀⠀⠀⠀⠀⠀⣠⣾⣿⣿⣿⣿⣿⣇⠈⢿⣿⣿⣿⣿⣿⡇⠀⣿⣿⣿⣿⣿⣿⠏⢀⣿⣿⣿⣿⣿⣿⣦⡀
                                    ⠀⠀⠀⠀⠀⠘⢿⣿⣿⣿⣿⣿⣿⣿⡆⠘⣿⣿⣿⣿⣿⡇⠀⣿⣿⣿⣿⣿⡏⠀⣾⣿⣿⣿⣿⣿⣿⡿⠋⢀
                                    ⠀⠀⠀⣴⣿⣦⡀⠙⢿⣿⣿⣿⣿⣿⣿⡄⠸⣿⣿⣿⣿⡇⠀⣿⣿⣿⣿⡟⠀⣼⣿⣿⣿⣿⣿⣿⠟⢀⣴⣿⣧
                                    ⠀⠀⣼⣿⣿⣿⣿⣦⡀⠙⢿⣿⣿⣿⣿⣷⡀⢹⣿⣿⣿⡇⠀⣿⣿⣿⡿⠁⣰⣿⣿⣿⣿⣿⠟⢁⣴⣿⣿⣿⣿⣧
                                    ⠀⣼⣿⣿⣿⣿⣿⣿⣿⣦⡀⠙⢿⣿⣿⣿⣧⠀⢻⣿⣿⡇⠀⣿⣿⣿⠃⢰⣿⣿⣿⣿⠟⢁⣴⣿⣿⣿⣿⣿⣿⣿⣧
                                    ⠀⠛⠿⢿⣿⣿⣿⣿⣿⣿⣿⣦⡀⠙⢿⣿⣿⣇⠀⢿⣿⡇⠀⣿⣿⠇⢠⣿⣿⣿⠟⢁⣴⣿⣿⣿⣿⣿⣿⣿⣿⡿⠟⠃
                                    ⣼⣶⣤⣄⡈⠙⠛⠿⣿⣿⣿⣿⣿⣦⡀⠙⢿⣿⡆⠈⠛⠃⠀⠛⠋⠀⣾⣿⠟⠁⣠⣾⣿⣿⣿⣿⡿⠿⠛⠉⣀⣠⣴⣶⡄
                                    ⣿⣿⣿⣿⣿⣿⣶⣤⣀⡉⠙⠻⢿⣿⣿⣦⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠈⠁⢠⣾⣿⣿⠿⠛⠋⢁⣠⣴⣶⣿⣿⣿⣿⣿⣿⡀
                                    ⢻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣦⣤⣀⠉⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠋⢁⣀⣤⣶⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧
                                    ⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⠁⠀⣠⣶⣄
                                    ⠀⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⡄⠀ ⢻⣿⣿⡿
                                    ⠀⠘⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠓⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠂⠀⠈⠙⠋
                                    ⠀⠀⠘⣿⣿⣿⣿⣿⠿⠛⠋⢁⣠⣤⣶⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠟⠋
                                    ⠀⠀⠀⠘⠟⠋⢉⣀⣤⣶⣿⣿⣿⣿⠟⠁⣠⣦⣄⡀⠀⠀⠀⠀⠀⠀⣤⣦⡈⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠛⠁
                                    ⠀⠀⠀⠀⠀⠘⢿⣿⣿⣿⣿⣿⠟⠁⣠⣾⣿⣿⣿⣿⣿⣶⣶⣾⣧⠀⢻⣿⣿⣦⡈⠻⣿⣿⣿⣿⡿⠟⠉
                                    ⠀⠀⠀⠀⠀⠀⠀⠙⠿⣿⡟⠁⣠⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣇⠈⠿⢿⣿⣿⣦⡈⠻⠛⠉
                                    ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠀⠺⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠋⢀⣤⣤⡈⠙⠋⠁
                                    ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠙⠛⠻⠿⠿⠿⠿⠿⠿⠇⠀ ⣿⣿⣿⡇
                                    ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀   ⠈⠙⠋

                         /██   /██   /██   /██   /██████    /██████     /██████    /██      /██   /███████
                        | ██  | ██  | ███ | ██  |_  ██_/   /██__  ██   /██__  ██  | ███    /███  | ██__  ██
                        | ██  | ██  | ████| ██    | ██    | ██  \__/  | ██  \ ██  | ████  /████  | ██  \ ██
                        | ██  | ██  | ██ ██ ██    | ██    | ██        | ████████  | ██ ██/██ ██  | ███████/
                        | ██  | ██  | ██  ████    | ██    | ██        | ██__  ██  | ██  ███| ██  | ██____/
                        | ██  | ██  | ██\  ███    | ██    | ██    ██  | ██  | ██  | ██\  █ | ██  | ██
                        |  ██████/  | ██ \  ██   /██████  |  ██████/  | ██  | ██  | ██ \/  | ██  | ██
                         \______/   |__/  \__/  |______/   \______/   |__/  |__/  |__/     |__/  |__/
```
<p align="right"><b><sub>Version: 1.0.1</sub></b></p>

<p align="center"><b>Authors</b></p>
<p align="center">
Flavia Nogueira Braga<br>
Marcelle Spera<br>
Luís Fernando Mercier Franco<br></p>

# Self-diffusion coefficients for confined fluids in a slit pore 
<p align="justify">
This algorithm was originally designed to calculate the self-diffusion coefficient of the components of a confined system in tree dimensions from data obtained by a Molecular Dynamics Simulation with GROMACS. In this work, x and y will be called the parallel directions and z is the perpenticular direction, since the wall of the system is in the z axis. The self-diffusion coefficients for the parallel components are calculated based on the work developed by Liu and collaborators (<a href="https://doi.org/10.1021/jp0375057">Liu et al., <b>J. Phys. Chem. B</b>, 108, 21, 6595–6602, 2004</a>). The perpendicular self-diffusion coefficient calculation, however, is based on the work developed by Franco and collaborators (<a href="https://doi.org/10.1021/acs.jctc.6b00653">Franco et al., <b> J. Chem. Theory Comput.</b>, 12, 11, 5247–5255, 2016</a>).
  
   <em><p align="center">
  <b>Figure 01</b>. Example of slit pore of calcite containing methane and ethane.
  Click [here](https://user-images.githubusercontent.com/98060271/150574991-7e6f68b7-26fe-45f1-bae2-3cfec67c4ef3.png) to zoom the figure in.
</p></em>

![SC](https://user-images.githubusercontent.com/98060271/150574991-7e6f68b7-26fe-45f1-bae2-3cfec67c4ef3.png)
</p>

  
## Contents
* <a href="#disclaimer">1. Disclaimer</a>
* <a href="#language">2. Language</a>
* <a href="#building-and-compilation">3. Building and Compilation</a>
* <a href="#reporting-errors">4. Reporting Errors</a>
* <a href="#input-files-preparation">5. Input files preparation</a>
* <a href="#running-the-code">6. Running the Code</a>
* <a href="#files-and-folders">7. Alternative code - Tolerance time </a>


## Disclaimer
<p align="justify">
The authors make no warranties about the use of this software. The authors hold no liabilities for the use of this software. The authors do not recommend the use of this software whatsoever.The algorithm is made freely available to clarify any details discussed in the paper. All information contained herein regarding any specific methodology does not constitute or imply its endorsement or recommendation by the authors.
</p>

## Language
<p align="justify">
The main program, subroutines and functions contain some explanatory comments and are mainly written in C language. 
</p>

## Building and Compilation
<p align="justify">
  

  For compilation, we have used the GNU Compiler Collection (GCC). See more information on GCC
 <a href="https://gcc.gnu.org/">here</a>. We tested the algorithm using some GCC versions: 9.3.0 in Ubuntu 20.04 LTS and 7.5.0 in Ubuntu 18.04 LTS.
</p>

<p align="justify">
We have built the code for the calculation of the self-difusion coefficients using the following command line:
</p>

```console
gcc diff.c -o out -lm
```

<p align="justify">

</p>

## Reporting Errors
<p align="justify">
If you spot an error in the program files and all other documentation, please submit an issue report using the <a href="https://github.com/Flavianbraga/Diffusion/issues">Issues</a> tab.
</p>

## Input files preparation
<p align="justify">
Before running the code to obtain the coefficients, the user should first prepare the files obtained from Molecular Dynamics (MD) simulation. The program used for MD simulations was GROMACS (version 2018.03 tested). Multiple files are obtained as outputs in the simulation. Here, the files will be referred by "name.type".
</p>
First, it is necessary to obtain the mean density of the molecules in function of the distance in z. This was done using GROMACS and the files .trr and .tpr, as shown by the following command line:
</p>

```console
gmx density -f prod_out.trr -s prod_out.tpr -o density.xvg -sl 1000 -d z

```
For further details on how to use gmx density the user is referred to the GROMACS <a href="https://manual.gromacs.org/documentation/2018/onlinehelp/gmx-density.html">documentation</a> for the topic.
</p>
Next, the trajectory in function of the time step for each molecule must be obtained. Once again using GROMACS and files .trr and .tpr, as shown by the following command line:
</p>
  
```console
gmx trjconv -f prod_out.trr -s prod_out.tpr -pbc nojump -o out.gro

```
For further details on how to use gmx trjconv the user is referred to the GROMACS <a href="https://manual.gromacs.org/documentation/2018/onlinehelp/gmx-trjconv.html">documentation</a> for the topic.
</p>
In both cases, the molecule of interest to obtain the self-diffusion coefficient must be carefully specified. Only one type of molecule can be studied at a time. 
</p>
In order to obtain a compact file from the trajectories of the center of mass of the molecules, an additional code is needed: cmass.c. We have built the code using the following command line:
</p>

```console
gcc cmass.c -o out -lm
```
To run the code, the command line used was:

```console
./out 2 out.gro cmass.dat 5000000 100
```
Where the first argument refers to the number of pseudoatoms used to built the molecule. In the case of methane, using <a href="http://trappe.oit.umn.edu/">TraPPE forcefield</a>, for example, this number equals to one, while for ethane is two. The second argument, refers to the output of gmx trjconv while the third argument is the output of cmass.c. 
</p>
Special attention must be taken to the last arguments, as they refer to the inputs of the .mdp file in the simulation. The fourth argument is the number os steps of the simulation (nsteps in the .mdp file) and the fifth refers to the interval between the recorded positions in the simulation (nstxout in the .mdp file).

Moreover, a folder named "results" should also be created inside the folder that the programs are running, as shown by the command line:
```console
mkdir results
```
Attention: this code is not suitable for molecules with pseudoatoms of different mass.

An executable file with all the commands is also available: doit_diff.exe.
</p>

## Running the Code
<p align="justify">
As the code calculates the diffusion coefficient of molecules in confined fluids, the coefficients have a dependency of the position in z. Therefore, special care must be taken to chose the interval for calculation according to the density profile.It is only possible to calculate the coefficient for small layers inside the pore.  
  
  <em><p align="center">
  <b>Figure 02</b>. Example of a density profile of a 5nm slit pore of calcite containing methane.
  Click [here](https://user-images.githubusercontent.com/98060271/150573653-6eead4ac-9bbb-40dd-a763-3719de5496c1.jpg) to zoom the figure in.
</p></em>

![SC](https://user-images.githubusercontent.com/98060271/150573653-6eead4ac-9bbb-40dd-a763-3719de5496c1.jpg)
</p>

In this code, two major regions are analyzed. One in the center of the pore and the other one closer to the wall. 

To run the code for example for the center of the pore, the command line used was:
```console
./out cmass.dat 2.50 3.50 2.50 3.50 density.xvg 10 50
```
Where the first argument is the output of the cmass.c code. The second and third arguments refer to the minimum and maximum values considered for the parallel coefficients calculation while the forth and fifth refer to the perpendicular coefficient. The last ones are related to the interval chosen for the linear regression function.

Attention: for the perpendicular coefficient calculation a linear region of the density profile must be chosen. 

It is also important to make sure that the value for "slab" in the code is the same used in the gmx density. In other to best use the code, chose a tlim value to make sure the survival probability reaches zero. 

</p>

## Alternative code - Tolerance time
<p align="justify">
  An alternative code considers the addition of a tolerance time. The addition of a tolerance time is done by considering the possibility that the molecule return to the layer after a short period of time, implying that the displacement was reasonably small and is a modification in the methods previusly used (<a href="https://doi.org/10.1021/jp0375057">Liu et al., <b>J. Phys. Chem. B</b>, 108, 21, 6595–6602, 2004</a> and <a href="https://doi.org/10.1021/acs.jctc.6b00653">Franco et al., <b> J. Chem. Theory Comput.</b>, 12, 11, 5247–5255, 2016</a>). The periods of time of tolerance (dt) are a multiple of the time step of the simulation. This value is also an input of this code.
  
```console
gcc diff_timetolerance.c -o out -lm
```  
 To run the code for example for the center of the pore and dt = 1, the command line used was:
```console
./out cmass.dat 2.50 3.50 2.50 3.50 density.xvg 10 50 1
```
 Where the first argument is the output of the cmass.c code. The second and third arguments refer to the minimum and maximum values considered for the parallel coefficients calculation while the forth and fifth refer to the perpendicular coefficient. The two next ones are related to the interval chosen for the linear regression function. The last one is the tolerance time added.
  
